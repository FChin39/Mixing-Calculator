"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const getUsingComponents_1 = require("../getUsingComponents");
function createManifest(builder, component, compilation, cache) {
    const { options } = builder;
    const manifestPath = component.name + '.json';
    const config = component.getManifest();
    const prePath = path_1.default.relative(path_1.default.join('./', options.output, path_1.default.dirname(manifestPath)), path_1.default.join('./', options.output));
    const usingComponents = {};
    getUsingComponents_1.getUsingComponents(component.filename, compilation, options, prePath).forEach(component => {
        usingComponents[component.id] = component.path;
    });
    config.component = true;
    config.usingComponents = Object.assign(Object.assign({}, (config.usingComponents || {})), usingComponents);
    const source = JSON.stringify(config, null, 2);
    cache.invalid(manifestPath, source, () => {
        compilation.assets[manifestPath] = {
            source: () => source,
            size: () => Buffer.byteLength(source),
        };
    });
}
exports.default = createManifest;
