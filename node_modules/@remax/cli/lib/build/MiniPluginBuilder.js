"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const output_1 = __importDefault(require("./utils/output"));
const Builder_1 = __importDefault(require("./Builder"));
const config_miniPlugin_1 = __importDefault(require("./webpack/config.miniPlugin"));
class MiniPluginBuilder extends Builder_1.default {
    constructor(api, options) {
        super(api, options, 'miniplugin');
    }
    createWebpackConfig() {
        return config_miniPlugin_1.default(this);
    }
    run() {
        if (this.options.watch) {
            this.watch();
        }
        else {
            this.build();
        }
        return this.webpackCompiler;
    }
    watch() {
        this.webpackCompiler.watch({}, (error, stats) => {
            if (error) {
                console.log(error);
                output_1.default.error(error.message);
                throw error;
            }
            const info = stats.toJson();
            if (stats.hasErrors()) {
                info.errors.forEach(error => {
                    output_1.default.error(error);
                });
            }
            if (stats.hasWarnings()) {
                console.warn(info.warnings.join('\n'));
            }
        });
    }
    build() {
        this.webpackCompiler.run((error, stats) => {
            if (error) {
                output_1.default.error(error.message);
                throw error;
            }
            const info = stats.toJson();
            if (stats.hasErrors()) {
                info.errors.forEach(error => {
                    output_1.default.error(error);
                });
                process.exit(1);
            }
            if (stats.hasWarnings()) {
                info.warnings.forEach(warning => {
                    console.warn(warning);
                });
            }
        });
    }
}
exports.default = MiniPluginBuilder;
