import { existsSync } from 'fs';
import resolve from 'resolve';
import { getPath } from './helpers';
var runWalk = function (filePath, components, options) {
    var walk = function (filePath) {
        var _a = require(filePath).usingComponents, usingComponents = _a === void 0 ? {} : _a;
        Object.values(usingComponents).forEach(function (value) {
            var componentJsPath = '';
            var componentJsonPath = '';
            if (!componentJsPath) {
                var componentPath = getPath(filePath, value);
                componentJsPath = componentPath + ".js";
                componentJsonPath = componentPath + ".json";
            }
            try {
                componentJsPath = resolve.sync(value, { basedir: options.cwd });
                componentJsonPath = componentJsPath.replace(/\.js/, '.json');
            }
            catch (_a) {
                // ignore
            }
            if (!existsSync(componentJsPath) || !existsSync(componentJsonPath)) {
                console.error(componentJsPath + " \u6216 " + componentJsonPath + " \u4E0D\u5B58\u5728");
                return;
            }
            components.add(componentJsPath);
        });
    };
    walk(filePath);
};
export default function usingComponents(id, options) {
    var components = new Set();
    var filePath = id.replace(/\.js$/, '.json');
    if (!existsSync(filePath)) {
        console.error("\u6587\u4EF6 " + filePath + " \u4E0D\u5B58\u5728");
        return Array.from(components);
    }
    runWalk(filePath, components, options);
    return Array.from(components);
}
